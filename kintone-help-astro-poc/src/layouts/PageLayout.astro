---
import type { MarkdownLayoutProps } from "astro";
import Head from "./components/Head.astro";
import { env } from "../lib/env.js";
import { getCurrentPage, getSiteHomeSections } from "../lib/page";
import Disclaimer2 from "./components/Disclaimer2.astro";
import Footer from "./components/Footer.astro";
import Header from "./components/Header.astro";
import TreeNav from "./components/TreeNav.astro";
import Breadcrumb from "./components/Breadcrumb.astro";
import TreeNavToggle from "./components/TreeNavToggle.astro";
import GoToTop from "./components/GoToTop.astro";
import SupportInquiry from "./components/SupportInquiry.astro";
import Enquete from "./components/Enquete.astro";
import MegaNav from "./components/MegaNav.astro";
import LocaleModal from "./components/LocaleModal.astro";
import ArticleLink from "./components/ArticleLink.astro";
import ArticleNumber from "./components/ArticleNumber.astro";
import HeaderLabel from "./components/HeaderLabel.astro";
import PageNav from "./components/PageNav.astro";
import AnnouncementBanner from "./components/AnnouncementBanner.astro";

type Props = MarkdownLayoutProps<{
  title?: string;
  description?: string;
  weight?: number;
}>;

// サイトのセクション情報を取得
const sections = await getSiteHomeSections();

// 現在ページを特定
const currentPage = getCurrentPage(Astro, sections);

// 無効化チェック（frontmatter経由で直接アクセス）
const isDisabled = currentPage.frontmatter.disabled.includes(env.targetRegion);
---

<!doctype html>
<!-- TODO: {{.Site.LanguageCode}} を置き換える -->
<html lang="ja" prefix="og: https://ogp.me/ns#">
  <head>
    <Head page={currentPage} />
  </head>
  <!-- TODO: フォントサイズの指定を再現する -->
  <body class="font-{{.Lang}}">
    {
      isDisabled ? (
        <meta http-equiv="refresh" content="0; URL=/" />
      ) : (
        <>
          {env.targetRegion === "US" && <LocaleModal />}

          <AnnouncementBanner />

          <Header page={currentPage} />

          <div class="page-pad" />

          {env.meganav && (
            <>
              <div class="mnav-pad" />
              <MegaNav 
                lang={currentPage.lang}
                isHome={currentPage.isHome}
                type={currentPage.frontmatter.type}
                relPermalink={currentPage.relPermalink}
              />
            </>
          )}

          <div id="page" class="page">
            <div id="tree" class="tree-wrap">
              <TreeNav page={currentPage} />
            </div>

            <div id="contents" class="contents-wrap">
              {env.useWovn && <Disclaimer2 />}

              <main id="main" role="main">
                <Breadcrumb page={currentPage} />

                <article class="article" role="article">
                  <div class="id-title">
                    <h1>{currentPage.frontmatter.title}</h1>
                    <ArticleLink aliases={currentPage.frontmatter.aliases} />
                  </div>

                  <ArticleNumber aliases={currentPage.frontmatter.aliases} />

                  <HeaderLabel labels={currentPage.frontmatter.labels} />

                  <slot />
                </article>

                {currentPage.frontmatter.type === "series" && (
                  <PageNav 
                    nextInSection={currentPage.nextInSection} 
                    prevInSection={currentPage.prevInSection}
                  />
                )}
              </main>
            </div>

            <div class="sidebar-wrap">
              <nav id="rightside-bar">
                <h2 class="toc-title">i18n__todo__In_this_article</h2>
              </nav>
            </div>
          </div>

          <TreeNavToggle />
          <GoToTop />

          {env.supportInquiry && env.languageCode === "en-us" && (
            <SupportInquiry />
          )}

          <Enquete />
          <Footer page={currentPage} />
        </>
      )
    }
  </body>
</html>
