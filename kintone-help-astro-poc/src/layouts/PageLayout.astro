---
import type { MarkdownLayoutProps } from "astro";
import Head from "./components/Head.astro";
import { buildEnvConfig } from "../lib/env.js";
import { getPermalinks, isHomePage, getLangFromLanguageCode } from "../lib/url.js";
import Disclaimer2 from "./components/Disclaimer2.astro";
// import Related from "./components/Related.astro";
import Footer from "./components/Footer.astro";

type Props = MarkdownLayoutProps<{
  title?: string;
  description?: string;
  weight?: number;
}> & {
  // ページ固有設定
  jsonTree?: boolean;
  idSearch?: boolean;
  tocInTree?: boolean;
  supportInquiry?: boolean;
  
  // ページデータ
  disabled?: string[];
  aliases?: string[];
  labels?: string[];
  content?: string;
  type?: string;
  weight?: number;
  
  // 国際化
  i18n?: {
    inThisArticle?: string;
  }
};

const {
  frontmatter, 
  jsonTree = false,
  idSearch = false,
  tocInTree = false,
  supportInquiry = false,
  disabled = [],
  aliases = [],
  labels = [],
  content = "",
  type = "",
  weight = frontmatter.weight || 0,
  i18n = { inThisArticle: "In this article" }
 } = Astro.props;

// env設定を構築（環境変数から直接取得）
const envConfig = {
  ...buildEnvConfig(),
  regularPages: [], // TODO: 実際の関連ページデータを設定
};

// permalink と relPermalink を生成
const permalinks = getPermalinks(Astro.url, envConfig.domain);

// page オブジェクトを構築
const pageData = {
  isHome: isHomePage(Astro.url.pathname),
  isSection: false,
  title: frontmatter.title || "",
  description: frontmatter.description,
  content: content,
  permalink: permalinks.permalink,
  relPermalink: permalinks.relPermalink,
  weight: weight,
  params: {
    type: type,
    nolink: false,  // TODO: 実際の値を設定
  },
  lang: getLangFromLanguageCode(envConfig.languageCode),
};

// 無効化チェック
const isDisabled = disabled.includes(envConfig.targetRegion);

// 条件チェック用のヘルパー関数
const isGaroonNonJapanese = envConfig.product === "Garoon" && 
  envConfig.languageCode !== "ja-jp" && 
  envConfig.languageCode !== "ja-cn";
---

<!doctype html>
<!-- TODO: {{.Site.LanguageCode}} を置き換える -->
<html lang="ja" prefix="og: https://ogp.me/ns#">
  <head>
    <Head env={envConfig} page={pageData} />
  </head>
  <!-- TODO: フォントサイズの指定を再現する -->
  <body class="font-{{.Lang}}">
      {isDisabled ? (
        <meta http-equiv="refresh" content="0; URL=/" />
      ) : (
        <>
          {envConfig.targetRegion === "US" && <div>[LOCALE MODAL PARTIAL]</div>}
          
          <!-- Announcement banner -->
          <div>[ANNOUNCEMENT BANNER PARTIAL]</div>
          
          <!-- Header -->
          <div>[HEADER PARTIAL]</div>
          
          <div class="page-pad"></div>
          
          {envConfig.meganav && (
            <>
              <div class="mnav-pad"></div>
              <div>[MEGANAV PARTIAL]</div>
            </>
          )}
          
          <div id="page" class="page">
            <div id="tree" class="tree-wrap">
              {jsonTree ? (
                <div>[TREENAV3 PARTIAL (JSON)]</div>
              ) : (
                <div>[TREENAV PARTIAL]</div>
              )}
            </div>
            
            <div id="contents" class="contents-wrap">
              {isGaroonNonJapanese && <div>[DISCLAIMER PARTIAL]</div>}
              
              {envConfig.useWovn && <Disclaimer2 env={envConfig} page={pageData} />}
              
              <div>[LATEST PAGE GUIDE PARTIAL]</div>
              
              <main id="main" role="main">
                <div>[BREADCRUMB PARTIAL]</div>
                
                <article class="article" role="article">
                  <div class="id-title">
                    <h1>{frontmatter.title}</h1>
                    {idSearch && aliases && aliases.length > 0 && (
                      <div>[ARTICLE LINK TEMPLATE]</div>
                    )}
                  </div>
                  
                  {idSearch && aliases && aliases.length > 0 && (
                    <div>[ARTICLE NUMBER TEMPLATE]</div>
                  )}
                  
                  {labels && labels.length > 0 && (
                    <div>[HEADER LABEL TEMPLATE]</div>
                  )}

                  <slot />
                </article>
                
                {/* <Related env={envConfig} page={pageData} /> */}
                
                {type === "series" && <div>[PAGE NAV PARTIAL]</div>}
              </main>
            </div>
            
            {!tocInTree && (
              <div class="sidebar-wrap">
                <nav id="rightside-bar">
                  <h2 class="toc-title">{i18n.inThisArticle}</h2>
                </nav>
              </div>
            )}
          </div>
          
          <div>[TREE NAV TOGGLE PARTIAL]</div>
          <div>[GO TO TOP PARTIAL]</div>
          
          {supportInquiry && envConfig.languageCode === "en-us" && (
            <div>[SUPPORT INQUIRY PARTIAL]</div>
          )}
          
          <div>[ENQUETE PARTIAL]</div>
          <Footer env={envConfig} page={pageData} />
        </>
      )}
  </body>
</html>
