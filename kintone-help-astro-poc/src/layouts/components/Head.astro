---
import { env } from "@/lib/env";
import AlternateLink from "./AlternateLink.astro";
import Gtm from "./Gtm.astro";
import type { BaseProps } from "./types";

interface Props extends BaseProps {}

const { page } = Astro.props;

// ビルド番号の生成
const buildnum = new Date().toISOString().slice(0, 10).replace(/-/g, "");

// WOVN設定
const wovnConfig = () => {
  if (!env.useWovn) return "";

  const baseUrlParts = env.baseURL.split("/");
  const prefix = baseUrlParts[baseUrlParts.length - 2] || "";

  return `https://j.wovn.io/1?key=${env.dataWovnio}&amp;defaultLang=en&amp;currentLang=en&amp;urlPattern=path&amp;backend=true&amp;langCodeAliases={&quot;en&quot;:&quot;en&quot;}&amp;sitePrefixPath=${prefix}&amp;langParamName=wovn&amp;backendVersion=WOVN.proxy_0.9.0`;
};

// サイト名の生成
const generateSiteName = () => {
  let sitename = "";
  const servicetype = env.serviceType || "";

  if (env.serviceTypeId === "on-premise" && env.languageCode === "en-us") {
    sitename = `${env.productName} ${servicetype}`.trim();
  } else {
    sitename = `${servicetype} ${env.productName}`.trim();
  }

  return `${sitename} ${env.help}`;
};

// ページタイトルの生成
const generateTitle = () => {
  // TODO: Title コンポーネントの出力を取得
  const baseTitle = ""; // Title コンポーネントから取得
  const sitename = generateSiteName();

  if (!page.isHome) {
    return `${baseTitle} | ${sitename}`;
  }
  return baseTitle;
};

// 説明文の生成
const generateDescription = () => {
  if (page.frontmatter.description) {
    // TODO: ApplyParams コンポーネントの機能を利用
    return page.frontmatter.description;
  }

  // TODO: i18n の実装
  const descBase = "i18n__todo__og_desc1";
  const desc2 = "i18n__todo__og_desc2";

  return `${descBase} ${desc2}`.trim();
};

const sitename = generateSiteName();
const title = generateTitle();
const description = generateDescription();

// robots の判定
const shouldNoIndex =
  page.frontmatter.type === "search_result" || false || env.staging === "true";

// Vue.js が必要な条件
const needsVue =
  (page.frontmatter.type === "search_result" &&
    (env.googleSearch || env.bingSearch)) ||
  page.frontmatter.type === "gr/section_top_video" ||
  page.frontmatter.type === "gr6/home";

// チャット設定の処理
const processChatSettings = () => {
  if (!env.chat) return [];

  const chatTargets = env.chat.split(",");
  const currentPage = page.relPermalink;

  return chatTargets.filter((target) => {
    const targetPath = `/${target}/`;
    return currentPage.includes(targetPath);
  });
};

const activeChatTargets = processChatSettings();
---

{env.useWovn && <script src={wovnConfig()} async />}

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=11" />
<meta name="date" content={buildnum} scheme="YYYYMMDD" />
<meta name="cy-template-version" content="2" />
<meta name="cy-product-name" content="kintone" />
<meta name="cy-region" content={env.targetRegion} />

<title>{title}</title>
<link rel="canonical" href={`https://${env.domain}${page.permalink}`} />

{shouldNoIndex && <meta name="robots" content="noindex,nofollow" />}

<meta name="description" content={description} />
<meta name="thumbnail" content={`https://${env.domain}${env.ogImg}`} />

{/* Open Graph タグ */}
<meta property="og:url" content={`https://${env.domain}${page.permalink}`} />
<meta property="og:type" content={page.isHome ? "website" : "article"} />
<meta property="og:site_name" content={sitename} />
<meta property="og:title" content={title} />
<meta property="og:image" content={`https://${env.domain}${env.ogImg}`} />
<meta property="og:description" content={description} />
<meta property="og:locale" content={env.languageCode} />

{/* モバイル設定 */}
<meta name="apple-mobile-web-app-title" content={title} />
<meta name="mobile-web-app-capable" content="yes" />
<meta
  name="apple-mobile-web-app-status-bar-style"
  content="black-translucent"
/>

{/* AlternateLink コンポーネント */}
<AlternateLink page={page} />

{/* ファビコン */}
<link
  rel="shortcut icon"
  type="image/x-icon"
  href={env.favicon || "favicon.ico"}
/>
<link rel="icon" type="image/x-icon" href={env.favicon || "favicon.ico"} />

{/* US地域の設定 */}
{
  env.targetRegion === "US" && (
    <>
      <link rel="stylesheet" href="https://use.typekit.net/fmt1ojn.css" />
      {/* TODO: 本番環境判定 */}
      {import.meta.env.MODE === 'production' && (
        <script
          is:inline
          type="text/javascript"
          src="https://cookie-cdn.cookiepro.com/consent/9d6098cc-90be-4d07-a9ef-6e07312a3016/OtAutoBlock.js"
        />
        <script
          is:inline
          src="https://cookie-cdn.cookiepro.com/scripttemplates/otSDKStub.js"
          type="text/javascript"
          charset="UTF-8"
          data-domain-script="9d6098cc-90be-4d07-a9ef-6e07312a3016"
        />
        <script type="text/javascript">function OptanonWrapper() {}</script>
      )}
    </>
  )
}

{/* CSS ファイル */}
<link rel="stylesheet" href={`/k/stylesheets/application.css?${buildnum}`} />
<link rel="stylesheet" href="/k/stylesheets/zoom.css" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<link rel="stylesheet" href={`/k/stylesheets/application2.css?${buildnum}`} />
<link rel="stylesheet" href={`/k/stylesheets/searchbox.css?${buildnum}`} />
<link rel="stylesheet" href={`/k/stylesheets/footer.css?${buildnum}`} />
{
  page.isHome && (
    <link rel="stylesheet" href={`/k/stylesheets/toppage2.css?${buildnum}`} />
  )
}

{
  page.frontmatter.type === "search_result" && (
    <link rel="stylesheet" href={`stylesheets/search_result.css?${buildnum}`} />
  )
}

{
  page.frontmatter.type === "gr/section_top_video" && (
    <link rel="stylesheet" href={`stylesheets/video_list.css?${buildnum}`} />
  )
}

{/* カスタムCSS */}
{
  env.customCss &&
    env.customCss
      .split(",")
      .map((cssFile: string) => (
        <link rel="stylesheet" href={`${cssFile.trim()}?${buildnum}`} />
      ))
}

{/* JavaScript ファイル */}
<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
></script>
<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"
></script>
<script is:inline src="/k/javascripts/zoom.js"></script>
<script is:inline src={`/k/javascripts/preload.js?${buildnum}`}></script>
<script is:inline src={`/k/javascripts/application.js?${buildnum}`}></script>
<script is:inline src={`/k/javascripts/langselector.js?${buildnum}`}></script>

{
  env.meganav && (
    <script is:inline src={`/k/javascripts/meganav.js?${buildnum}`} />
  )
}

{
  page.frontmatter.type === "gr6/home" && (
    <script is:inline src={`/k/javascripts/custom_gr6.js?${buildnum}`} />
  )
}

<script is:inline src={`/k/javascripts/searchbox.js?${buildnum}`}></script>
{
  page.isHome && (
    <script is:inline src={`/k/javascripts/toppage2.js?${buildnum}`} />
  )
}

{
  needsVue && (
    <script
      is:inline
      src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.8/vue.global.prod.min.js"
    />
  )
}

{/* Google Tag Manager */}
<Gtm key="GTM-5ZR5GF" />
<Gtm key="GTM-5N49D3" />
{env.targetRegion === "JP" && <Gtm key="GTM-K98FR27D" />}

{/* Zendesk チャット */}
{
  activeChatTargets.map((target) => (
    <Fragment>
      <script
        is:inline
        id="ze-snippet"
        src="https://static.zdassets.com/ekr/snippet.js?key=6549c743-a6eb-40ac-a71f-c479b0759f1c"
      />
      {/* TODO: チャットメニューの設定 */}
    </Fragment>
  ))
}
