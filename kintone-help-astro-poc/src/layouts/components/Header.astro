---
import SearchBox from './SearchBox.astro';
import LangSelector from './LangSelector.astro';
import Wovn from './Wovn.astro';

interface Props {
  env: {
    meganav?: boolean;
    targetRegion: string;
    product: string;
    templateVersion?: string;
    baseURL: string;
    logo?: string;
    productName: string;
    help: string;
    previewSite?: boolean;
    googleSearch?: boolean;
    searchAll?: string;
    langSelector?: boolean;
  };
  page: {
    isHome: boolean;
    lang: string;
    allTranslations: any[];
    isTranslated: boolean;
    params: {
      type?: string;
      [key: string]: any;
    };
    scratch?: {
      sitename?: string;
    };
  };
}

const { env, page } = Astro.props;

// ヘッダークラスの決定
let hedclass = "";
if (page.isHome && !env.meganav) {
  hedclass = "home-header";
} else if (page.isHome && env.targetRegion === "US") {
  hedclass = "home-header";
}

// v2プロダクトのリスト
const v2List = ["kintone", "slash", "support_guide", "store", "store-jp"];
const v2Prod = v2List.includes(env.product);

const templateVersion = env.templateVersion || "1";

// 言語設定
const langlen = page.allTranslations.length;
const baselang = langlen !== 0 ? `${page.lang}/` : "";

// ベースURLの計算
const urlparts = env.baseURL.split('/');
let base = "/";
if (env.product !== "support_guide") {
  const productPos = urlparts.length - 2;
  base = `/${urlparts[productPos]}/`;
}
const baseLink = `${base}${page.lang}/`;

// Google言語コードの変換
let glang = page.lang;
if (glang === "zh") {
  glang = "zh-CN";
} else if (glang === "zh-tw") {
  glang = "zh-TW";
}

// サーチボックス表示の判定
let dispSbox = true;
if (page.params.type === "search_result") {
  dispSbox = false;
} else if (page.isHome && v2Prod) {
  dispSbox = false;
} else if (page.params.type === "gr6/home") {
  dispSbox = false;
} else if (env.previewSite) {
  dispSbox = false;
}

// ロゴ/タイトルの決定
const shouldUseImage = env.product === "kintone" || env.targetRegion === "US";
const logoAlt = `${env.productName} ${env.help}`;

let logoTitle = "";
if (!shouldUseImage) {
  if (env.previewSite) {
    logoTitle = env.productName;
  } else {
    // TODO: page.scratch.sitename の実装
    logoTitle = `${page.scratch?.sitename || ''} ${env.help}`;
  }
}
---

<div id="shield"></div>
<header id="header" class={`header ${hedclass}`}>
  <div id="head" class="header-wrap">
    <div class="logo-wrap">
      {!page.isHome && templateVersion === "2" && (
        <button id="tree-switch-mobile" class="tree-switch-mobile">
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
      )}
      
      <h1>
        <a class="logo-link" href={baseLink}>
          {shouldUseImage ? (
            <img 
              class="logo-img" 
              src={`${base}${env.logo}`} 
              alt={logoAlt} 
              title={logoAlt}
            />
          ) : (
            <span class="logo-title">{logoTitle}</span>
          )}
        </a>
      </h1>
    </div>

    {dispSbox && (
      templateVersion === "2" ? (
        <SearchBox env={env} page={page} />
      ) : (
        <>
          <div id="search" class="search-wrap">
            <form 
              id="searchBox_form" 
              action={`${page.lang}/search_result.html`}
              onsubmit="if(document.getElementById('headerSearchBox_input').value==''){return false;}"
              role="search"
            >
              <div class="searchbox">
                <input 
                  type="search" 
                  name="q" 
                  id="headerSearchBox_input" 
                  class="search-input home-search-input" 
                  role="searchbox" 
                  aria-label="i18n__todo__search_word"
                  placeholder="i18n__todo__Enter_keywords"
                />
                <button 
                  type="submit" 
                  class="search-submit" 
                  data-disable-with="" 
                  aria-label="i18n__todo__search"
                ></button>
                {!env.googleSearch && (
                  <input type="hidden" name="ct" value={env.searchAll} />
                )}
              </div>
            </form>
          </div>

          {env.googleSearch && (
            <script 
              src="https://www.gstatic.com/prose/brand.js" 
              data-target-id="headerSearchBox_input" 
              data-hl={glang}
            ></script>
          )}
        </>
      )
    )}

    {page.isTranslated && env.langSelector && (
      <LangSelector env={env} page={page} />
    )}
  </div>
</header>