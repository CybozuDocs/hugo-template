---
import Wovn from './Wovn.astro';

interface Props {
  env: {
    googleSearch?: boolean;
    bingSearch?: boolean;
    googleSearchTabs?: string;
    bingSearchTabs?: string;
    product: string;
  };
  page: {
    isHome: boolean;
    lang: string;
    params: {
      type?: string;
    };
  };
}

const { env, page } = Astro.props;

// フィルターパラメータの処理
let paramFilter = "";
if (env.googleSearch) {
  paramFilter = env.googleSearchTabs || "";
} else if (env.bingSearch) {
  paramFilter = env.bingSearchTabs || "";
}

// フィルター配列の生成
let filter: string[] = [];
if (paramFilter.length > 0) {
  const trimmed = paramFilter.replace(/^\[/, '').replace(/\]$/, '');
  filter = trimmed.split(',');
}

// フルサイズ判定
const fullsize = page.isHome || page.params.type === "search_result";

// プレースホルダーの決定
let placeholder = "";
if (env.product === "support_guide") {
  placeholder = "i18n__todo__Enter_keywords";
} else if (!fullsize) {
  placeholder = "";
} else {
  placeholder = "i18n__todo__Search_example";
}

// Google言語コードの変換
let glang = page.lang;
if (glang === "zh") {
  glang = "zh-CN";
} else if (glang === "zh-tw") {
  glang = "zh-TW";
}

// ロゴプレース
const logoplace = fullsize ? "logo_place" : "search-input";

// ボタンスタイルの決定
let buttonstyle = "search-filter-current";
if (fullsize) {
  buttonstyle += " search-filter-current-top";
}
---

<div id="search" class="search-wrap" role="search">
  <div class="searchbox">
    {paramFilter && (
      <button 
        id="search-filter-current" 
        class={buttonstyle} 
        title="i18n__todo__Search_filter"
        aria-controls="search-filter-list" 
        aria-haspopup="listbox" 
        aria-expanded="false" 
        role="combobox"
      >
        {filter[0]?.replace(/^'|'$/g, '') || ''}
      </button>
    )}
    
    <div 
      id="search-filter-list" 
      class="search-filter-list" 
      aria-labelledby="search-filter-current" 
      role="listbox" 
      tabindex="-1"
    >
      <ul>
        {filter.map((value, idx) => (
          <li 
            class={`search-filter-item${idx === 0 ? ' search-filter-selected' : ''}`}
            listid={idx} 
            role="option" 
            aria-selected="false"
          >
            {value.replace(/^'|'$/g, '')}
          </li>
        ))}
      </ul>
    </div>
    
    <input 
      type="search" 
      id="search-input" 
      class="search-input" 
      placeholder={placeholder}
      aria-label="i18n__todo__search_word"
    />
    
    <button 
      class="search-submit" 
      title="i18n__todo__search"
      aria-label="i18n__todo__search"
    ></button>
  </div>
  
  {fullsize && (
    <div 
      id="logo_place" 
      class={`search-logo${env.bingSearch ? ' search-logo-bing' : ''}`}
    >
      {env.bingSearch && (
        <span>
          <Wovn>i18n__search_bing</Wovn>
          {' ('}
          <a href="https://www.microsoft.com/en-gb/privacy/privacystatement" target="_blank">
            <Wovn>i18n__search_bing_legal</Wovn>
          </a>
          {')'}
        </span>
      )}
    </div>
  )}
</div>

{env.googleSearch && (
  <script 
    src="https://www.gstatic.com/prose/brand.js" 
    data-target-id={logoplace} 
    data-hl={glang}
  ></script>
)}