---
import Title from './Title.astro';
import MegaNavGrGetSecond from './MegaNavGrGetSecond.astro';
import MegaNavGrSectBar from './MegaNavGrSectBar.astro';
import MegaNavGrMegaPanel from './MegaNavGrMegaPanel.astro';
import MegaNavGrTitleIcon from './MegaNavGrTitleIcon.astro';
import Wovn from '@/components/Wovn.astro';
import type { BaseProps } from './types';

interface Props extends BaseProps {}

const { env, page } = Astro.props;

// GetSecond処理の代替（簡易実装）
const getSecondSection = (currentPage: any): any => {
  let current = currentPage;
  let second = null;
  
  while (current.parent && current !== current.firstSection) {
    second = current;
    current = current.parent;
  }
  
  return second;
};

const secondsect = getSecondSection(page);
const entries = env.siteHomeSections || [];
const rootsect = page.firstSection;

// seconditems の計算
let seconditems = rootsect?.pages?.length || 0;

if (page.isHome) {
  seconditems = 0;
} else if (rootsect && ["video", "purpose", "guide", "pdf", "glossary", "error", "mobile"].some(section => 
  rootsect.relPermalink?.includes(section))) {
  seconditems = 0;
} else if (page.params?.type === "search_result" || page.params?.type === "gr/sitemap") {
  seconditems = 0;
}

// URL解析（簡易実装）
const baseURL = new URL(env.baseURL || 'https://example.com');

// entries をweight順にソート
const sortedEntries = entries.sort((a: any, b: any) => (a.weight || 0) - (b.weight || 0));
---

<nav role="navigation" aria-label="i18n__todo__Document_type">
  <ul class="g-nav" role="none">
    {sortedEntries.map((entry: any) => (
      entry.params?.weight !== 0 && (
        <li class="g-col" role="none">
          <a 
            href={entry.relPermalink}
            class={entry.currentSection === rootsect ? "current" : undefined}
            aria-current={entry.currentSection === rootsect ? "page" : undefined}
          >
            <span class="g-nav-title-wrap">
              <MegaNavGrTitleIcon targetlink={entry.relPermalink} />
              <Title page={entry} env={env} />
            </span>
          </a>
        </li>
      )
    ))}
    
    {env.faqLink && (
      <li class="g-col" role="none">
        <a href={env.faqLink} target="_blank">
          <span class="g-nav-title-wrap">
            <Wovn>i18n__Header_nav_faq</Wovn>
            <span class="g-nab-title-icon-right">
              <i class="fas fa-external-link-alt" aria-hidden="true"></i>
            </span>
          </span>
        </a>
      </li>
    )}
  </ul>

  <div class={`mega-nav ${page.params?.type === "gr6/home" ? "mega-nav-home" : ""}`}>
    {seconditems > 0 && (
      <>
        <div class="mega-tab-wrap">
          <div class="mega-tab-head">
            <h2 class="mega-tab-guide">
              <Wovn>i18n__By_features</Wovn>
            </h2>
          </div>
          <div id="mega-tab-bar" class="mega-tab-bar">
            {sortedEntries.map((entry: any) => (
              entry.currentSection === rootsect && (
                <MegaNavGrSectBar cursect={rootsect} secondsect={secondsect} env={env} />
              )
            ))}
          </div>
        </div>

        {sortedEntries.map((entry: any) => (
          entry.currentSection === rootsect && (
            <MegaNavGrMegaPanel cursect={rootsect} env={env} />
          )
        ))}
      </>
    )}
  </div>
</nav>