# 🔴 WORK.md 必読: Hugo → Astro 変換スクリプト 作業ルール 🔴

## ⚠️ 絶対必須: 作業開始前のチェックリスト ⚠️

**🚨 このチェックリストを実行せずに作業開始は禁止 🚨**

### Step 1: 記憶確認（必須実行）
- [ ] **1-1**: このファイル（WORK.md）を最後まで読んだ
- [ ] **1-2**: 「作業原則: WORK.md の内容を理解してから作業を実施します」を回答冒頭に必ず記載
- [ ] **1-3**: `migration-docs/0034_content-to-mdx-script/prompt.md` を確認した（記憶不明時のみ）
- [ ] **1-4**: **一度読んだ後も、トラブル・エラー発生時は必ずWORK.mdを再読する**

### Step 2: 標準コマンド確認（必須実行）
- [ ] **2-1**: 以下の標準コマンドを確認した:
```bash
npx tsx migrate-scripts/convert-content.ts \
  --preprocessor migrate-scripts/preprocessors/kintone-preprocessors.js \
  --image-path-from "/k/" \
  --image-path-to "/k/kintone/" \
  <入力ディレクトリ> \
  <出力ディレクトリ>
```
- [ ] **2-2**: **このコマンド以外の実行方法（deno、独自テスト等）は絶対禁止**
- [ ] **2-3**: 入力ディレクトリのパスを事前に確認済み

### Step 3: 基本原則確認（必須実行）
- [ ] **3-1**: 直接編集は絶対禁止（プリプロセッサまたは変換スクリプトのみ）
- [ ] **3-2**: 個別ファイル問題 → プリプロセッサ / 全体問題 → 変換スクリプト

### Step 4: 作業品質管理（必須実行）
- [ ] **4-1**: ユーザーの期待結果を正確に理解・記録した
- [ ] **4-2**: 作業完了の定義を明確化した（期待結果との完全一致）
- [ ] **4-3**: 謝罪よりも結果重視の姿勢で取り組む
- [ ] **4-4**: セルフチェックを必ず実施する（後述の必須項目参照）

---

## 🔴 重要: 絶対遵守ルール

### 1. 直接編集の絶対禁止
- **ユーザー指示**: 「直接編集は禁止です。絶対に禁止です。」
- **対応方法**: すべての修正は変換スクリプトまたはプリプロセッサで対応

### 2. 修正対応の判断基準
- **個別ファイル固有の問題** → プリプロセッサによる修正（`kintone-preprocessors.js`）
- **全体的な変換ロジックの問題** → 変換スクリプト自体の修正（各処理モジュール）

### 3. プリプロセッサ動作確認手順（必須）
1. **ダミー変換で動作確認**: 複雑な処理前に簡単な文字列置換でテスト
2. **元ファイル構造確認**: 正規表現作成前に必ず詳細確認
3. **filePath一貫性確認**: 既存のプリプロセッサと同じ形式で指定

### 4. 正規表現の使用制限
- 基本は単純な文字列置換（`replaceAll`）を優先
- 正規表現はマルチライン処理など必要な場合のみ使用

---

## 🔍 よくある問題パターン（症状→対応）

### インデント不一致
- **症状**: "Expected a closing tag for \<Component\> before the end of listItem"
- **対応**: 変換スクリプト自体の修正（shortcode-processor.ts等）

### wv_brkショートコード変換問題
- **症状**: {{< wv_brk >}}...{{< /wv_brk >}} がそのまま残る
- **対応**: 変換スクリプト修正（インライン処理とブロック処理の分離）

### Noteコンテンツのインデント不一致
- **症状**: "Expected a closing tag for \<Note\> before the end of listItem" 
- **対応**: 変換スクリプト修正完了（shortcode-processor.tsのadjustContentIndentation関数）

### Noteコンテンツ内のリスト項目間の不要な空行
- **症状**: リスト項目（`*`）とその直後のサブ項目（リンク等）の間に不要な空行が残る
- **対応**: shortcode-processor.tsの空行削除ロジック修正（lines配列の元データで判定）
- **解決方法**: 元の行データで前行がリスト項目、次行がインデントされたコンテンツの場合、空行をスキップ

---

## ❌ よくある作業ミス（絶対回避）

### コマンド実行ミス
- **ミス**: 標準コマンドを無視して独自形式で実行
- **対策**: **上記Step 2-1のコマンドのみ使用**

### プリプロセッサ作成ミス
- **ミス**: ダミー変換なしでいきなり複雑な処理を実装
- **対策**: **必ずダミー変換→実処理の順番で実装**

### filePathミス
- **ミス**: 既存のプリプロセッサと異なる形式でパス指定
- **対策**: **既存のfilePath形式を必ず参考にする**

### セルフチェック不備
- **ミス**: 結果を正確に確認せず「完璧」「完了」と誤った判断
- **対策**: **必ず期待結果と実際の結果を行単位で比較確認**

### 標準コマンド無視
- **ミス**: WORK.mdに明記された標準コマンドを無視してdeno等で実行
- **対策**: **WORK.md記載のコマンド以外は絶対使用禁止**

### 期待結果理解不足
- **ミス**: ユーザーの期待結果を正確に把握せず、推測で作業
- **対策**: **期待結果を正確に記録し、完全一致するまで作業継続**

---

## ✅ 作業完了時の必須確認チェックリスト

**🚨 作業完了時はこのチェックリストを必ず実行 🚨**

### セルフチェック必須項目
- [ ] **チェック-1**: 期待結果と実際の結果を行単位で比較確認した
- [ ] **チェック-2**: 標準コマンドで変換を実行した（deno等は使用していない）
- [ ] **チェック-3**: 変換対象ファイルの内容を実際に読み込んで確認した
- [ ] **チェック-4**: 他のファイルに意図しない影響が出ていないことを確認した
- [ ] **チェック-5**: ユーザーの期待結果との完全一致を確認した

### ドキュメント更新
- [ ] **完了-1**: ドキュメント更新を実施した
- [ ] **完了-2**: WORK.md更新を実施した  
- [ ] **完了-3**: prompt.md更新を実施した
- [ ] **完了-4**: 新しい問題パターンをWORK.mdに追加した（該当時のみ）

---

## 📋 プリプロセッサルール追加テンプレート

```javascript
{
  filePath: "app/対象ディレクトリ/ファイル名.md",
  transform: (content) => {
    // コメント: 何を修正するかを明記
    return content.replaceAll('問題のある文字列', '修正後の文字列');
  }
}
```

---

## 🔄 記憶喪失時・トラブル発生時の復旧手順

**🚨 以下の状況では必ずこの手順を実行 🚨**
- 記憶が曖昧な場合
- エラーが発生した場合  
- 期待結果にならない場合
- 作業が行き詰まった場合
- 標準コマンドがわからない場合

### 復旧手順
1. **このファイル（WORK.md）を最初から最後まで読む**
2. **上記の「絶対必須チェックリスト」を実行する**
3. **`migration-docs/0034_content-to-mdx-script/prompt.md` で詳細履歴を確認**
4. **不明点があれば遠慮なくユーザーに確認**

### トラブル時の必須アクション
- [ ] **トラブル-1**: WORK.mdを全文再読した
- [ ] **トラブル-2**: 該当する問題パターンをWORK.mdで確認した
- [ ] **トラブル-3**: 標準コマンドを正しく使用しているか確認した
- [ ] **トラブル-4**: 期待結果を正確に理解しているか確認した

---

## 💡 重要な認識

- この作業は「完成」するものではなく、継続的改善が必要
- 大量のファイルで類似のエラーが継続発生する
- 新しい問題パターンが継続的に発見される
- **毎回WORK.mdを読まずに作業開始するのは最大のミス**
- **謝罪よりも結果が重要 - ユーザーは解決を求めている**
- **セルフチェックの甘さが最も深刻な品質問題**
- **期待結果との完全一致が作業完了の唯一の基準**

---

**🔴 最重要リマインダー 🔴**
- **作業開始時は必ず「作業原則: WORK.md の内容を理解してから作業を実施します」を発言**
- **トラブル発生時は即座にWORK.mdを再読する（推測や試行錯誤の前に必読）**
- **期待結果にならない場合は必ずWORK.mdの該当セクションを確認する**

---

**最終更新**: 2025-01-02（Noteコンテンツ空行削除問題対応、作業品質管理強化）
**次回更新**: 新しい問題パターン発見時、または重要なルール変更時